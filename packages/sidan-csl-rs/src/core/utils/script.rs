use cardano_serialization_lib::JsError;
use model::{LanguageVersion, ScriptSource, SimpleScriptSource};

use crate::*;

pub fn get_native_script_hash(script: &str) -> Result<String, JsError> {
    let script_hash = csl::NativeScript::from_hex(script)?.hash().to_hex();
    Ok(script_hash)
}

pub fn get_script_hash(script: &str, version: LanguageVersion) -> Result<String, JsError> {
    let language_version = match version {
        LanguageVersion::V1 => csl::Language::new_plutus_v1(),
        LanguageVersion::V2 => csl::Language::new_plutus_v2(),
        LanguageVersion::V3 => csl::Language::new_plutus_v3(),
    };
    let script_hash = csl::PlutusScript::from_hex_with_version(script, &language_version)?
        .hash()
        .to_hex();
    Ok(script_hash)
}

pub fn to_csl_script_source(
    script_source: ScriptSource,
) -> Result<csl::PlutusScriptSource, JsError> {
    match script_source {
        ScriptSource::InlineScriptSource(script) => {
            let language_version: csl::Language = match script.language_version {
                LanguageVersion::V1 => csl::Language::new_plutus_v1(),
                LanguageVersion::V2 => csl::Language::new_plutus_v2(),
                LanguageVersion::V3 => csl::Language::new_plutus_v3(),
            };
            Ok(csl::PlutusScriptSource::new_ref_input(
                &csl::ScriptHash::from_hex(&script.script_hash)?,
                &csl::TransactionInput::new(
                    &csl::TransactionHash::from_hex(&script.ref_tx_in.tx_hash)?,
                    script.ref_tx_in.tx_index,
                ),
                &language_version,
                script.script_size,
            ))
        }
        ScriptSource::ProvidedScriptSource(script) => {
            let language_version: csl::Language = match script.language_version {
                LanguageVersion::V1 => csl::Language::new_plutus_v1(),
                LanguageVersion::V2 => csl::Language::new_plutus_v2(),
                LanguageVersion::V3 => csl::Language::new_plutus_v3(),
            };
            Ok(csl::PlutusScriptSource::new(
                &csl::PlutusScript::from_hex_with_version(
                    script.script_cbor.as_str(),
                    &language_version,
                )?,
            ))
        }
    }
}

pub fn to_csl_simple_script_source(
    simple_script_source: SimpleScriptSource,
) -> Result<csl::NativeScriptSource, JsError> {
    match simple_script_source {
        SimpleScriptSource::ProvidedSimpleScriptSource(script) => Ok(csl::NativeScriptSource::new(
            &csl::NativeScript::from_hex(&script.script_cbor)?,
        )),

        SimpleScriptSource::InlineSimpleScriptSource(script) => {
            Ok(csl::NativeScriptSource::new_ref_input(
                &csl::ScriptHash::from_hex(&script.simple_script_hash)?,
                &csl::TransactionInput::new(
                    &csl::TransactionHash::from_hex(&script.ref_tx_in.tx_hash)?,
                    script.ref_tx_in.tx_index,
                ),
                script.script_size,
            ))
        }
    }
}

#[wasm_bindgen]
pub fn get_v2_script_hash(script: &str) -> String {
    csl::PlutusScript::from_hex_with_version(script, &csl::Language::new_plutus_v2())
        .unwrap()
        .hash()
        .to_hex()
}

#[cfg(test)]
mod test {
    use crate::{
        core::utils::{apply_double_cbor_encoding, get_script_hash},
        model::LanguageVersion,
    };

    #[test]
    fn test_get_script_hash_v2_escrow() {
        let script = "590c2f01000032323232323232232323232323232232322533300d3232533300f300c3010375400226464646464646464a66602e602a60306ea80044c8c8c8c8c8c8c8c8c8c94ccc084c07c0244c8c8c8c8c8c8c94ccc0acc0b800c4c94ccc0b0c0bc00c4c94ccc0a8c080c0acdd5000899192999816181118169baa001132533302d302b302e3754006264646464a666068606e004264646464a66606a66ebc024cdd2a40046607200e660726e98014cc0e404ccc0e4dd300925eb8040045281980b9bab302730363754018660326eacc09cc0d8dd51813981b1baa00d301a011302c0073302c0022323302e3756606c0044646eb4c0e0008dd7181b0009bae3034001302c003163756606a002606a0046066002605e6ea800c58c0c4c0b8dd50008b180798169baa003302f302c37540022c601a60566ea8c070c0acdd50010b18168010b18160011bac302b302c00237586054002660506e9ccc01004c034cc0a0dd399802808806a5eb80dd598141814801181380098119baa01813232325333024302100c132323232533302b302e0031533302b0021325333029301f302a375400226464a666056605260586ea80084c94ccc0b0c0a8c0b4dd500089980500c1bae3031302e37540022c60106060605a6ea80084c8c8c8c8c8c8c8c94ccc0ccc0c4c0d0dd500089919299981a9819981b1baa0011533303532330010013303a375200666074607660706ea80092f5c044a66607400229404c94ccc0e0cc058090dd7181e8010a51133003003001303d00115333035005100414a0294058c044014dd7181c181a9baa00116300f006330143301001e00230173756606c606e006660266601e03a008602c6eacc0d400cc0d0004c0d0004c0cc008c0c4004c0b4dd50011811800981718159baa00116300c302a3754603660546ea80045858c0b0008dd6181598160011bac302a00133028374e6600802601a660506e9ccc0140440352f5c0264646464a666056605c0062a666056004264a666052603e60546ea80044c94ccc0a8c09cc0acdd500089919191919191919299981a981c001099191919191919299981c981b981d1baa00113232533303b3039303c37540022a6660766466002002660806ea400ccc100c104c0f8dd500125eb80894ccc100004528899299981f1980e0151bae304300213300300300114a060860022a66607600a200829405280b180b8059bae303e303b37540022c602a01a660346602c048010603a014660326602a046016603800a6605e008464660626eacc0e40088c8dd6981d8011bae3039001375c606e002605e00a6605a00c4646605e6eacc0dc0088c8dd6981c8011bae3037001375c606a002605a00e2c6eacc0d8004c0d8008c0d0004c0d0008dd598190009819001181800098161baa00116302e302b37540022c601860546ea8c06cc0a8dd50008b0b18160011bac302b302c00237586054002660506e9ccc01004c034cc0a0dd399802808806a5eb808c94ccc094c08cc098dd50008980819814981518139baa0014bd700a6103d87a800030153026375400244646600200200644a66605200229404c94ccc09ccdc79bae302c00200414a2266006006002605800244646600200200644a666050002297adef6c601332253330273375e603060526ea80080144cc030004dd5980d18149baa0021001302a00133002002302b001223300400223375e6028604a6ea8c058c094dd50008011119801801119baf30133024375400200444646600200200644a66604a002297ae013232533302430050021330280023300400400113300400400130290023027001223233001001323300100100322533302500114bd7009919991119198008008019129998158008801899198169ba73302d375200c6605a60540026605a605600297ae033003003302f002302d001375c60480026eacc094004cc00c00cc0a4008c09c004894ccc09000452889929998111919b89375a600e002664464a66604c6046604e6ea8004520001375a605660506ea8004c94ccc098c08cc09cdd50008a60103d87a8000132330010013756605860526ea8008894ccc0ac004530103d87a8000132323232533302c337220100042a66605866e3c0200084c05ccc0c0dd4000a5eb80530103d87a8000133006006003375a605a0066eb8c0ac008c0bc008c0b4004c8cc004004024894ccc0a80045300103d87a8000132323232533302b337220100042a66605666e3c0200084c058cc0bcdd3000a5eb80530103d87a8000133006006003375660580066eb8c0a8008c0b8008c0b0004dd7180a0009bae30160013758604e0042660060060022940c09c0048c088c08cc08c00488c8ccc00400400c0088894ccc08c00840044c8ccc010010c09c00ccccc020008dd718110009bab3023001222325333025533302800114a229405300103d87a80001301033029374c00297ae032333001001003002222533302a0021001132333004004302e0033322323300100100522533302f001133030337606ea4010dd4001a5eb7bdb1804c8c8c8c94ccc0c0cdc800400109981a19bb037520106ea001c01454ccc0c0cdc78040010992999818981798191baa001133035337606ea4024c0d8c0ccdd5000802080219299981898178008a60103d87a80001301c33035375000297ae03370000e00226606866ec0dd48011ba800133006006003375a60620066eb8c0bc008c0cc008c0c4004dd718148009bad302a001302c00230250022323300100100222533302000114bd6f7b6300999119191999804001801000911319190011919198008008019129998138008a4c264a6660500022a66604a60086eb4c09cc0a8008526161323232325333029337206eb8c0a8010dd718150018a9998149804000899803803998168018010b0b1bad302a003302d003302b002302a002302a001233302230200014a0944dd598110019bae3020002302200133002002302300122223233001001005225333022001133023337606ea4014dd300225eb7bdb1804c8c8c8c94ccc08ccdc800480109981399bb037520126e9802001454ccc08ccdc78048010992999812181118129baa001133028337606ea4028c0a4c098dd5000802080219980380480400089981399bb037520046e98004cc01801800cdd598120019bae3022002302600230240013019375401e601060326ea8c028c064dd5180e180c9baa0011632323300100100722533301c00114c0103d87a800013232533301b3375e6018603a6ea80080144c018cc07c0092f5c02660080080026040004603c002603660306ea8020dd2a40006eb0c064c068c068c068c068c068c068008dd6180c000980c180c0011bac301600130123754600260246ea80108c054004528180098081baa00223013301400114984d958c94ccc030c0280044c8c8c8c94ccc04cc0580084c8c9263300b0022323300d3756602a0044646eb4c05c008dd7180a8009bae3013001300b003163756602800260280046024002601c6ea800c54ccc030c02400454ccc03cc038dd50018a4c2c2a66601860040022a66601e601c6ea800c5261616300c37540046e1d20043001007232533300930070011323232325333010301300213232498cc0200088c8cc028dd598090011191bad3014002375c60240026eb8c040004c02000c58dd598088009808801180780098059baa0021533300930060011323232323232323253330143017002132323232498cc0380108c8cc040dd5980c0011191bad301a002375c60300026eb8c058004c038014cc0300188c8cc038dd5980b0011191bad3018002375c602c0026eb8c050004c03001c58dd5980a800980a801180980098098011bab30110013011002300f001300b37540042c60126ea800488c8cc00400400c894ccc0340045261323300300330110023003300f00125333006300430073754002264646464a66601a602000426464931929998061805000899192999808980a00109924c64a66601e601a00226464a666028602e0042649318068008b180a80098089baa0021533300f300c00113232323232325333018301b002149858dd6980c800980c8011bad30170013017002375a602a00260226ea800858c03cdd50008b180900098071baa0031533300c30090011533300f300e37540062930b0b18061baa002300600316300e001300e002300c001300837540022c464a66600c600800226464a666016601c0042930b1bae300c001300837540042a66600c600600226464a666016601c0042930b1bae300c001300837540042c600c6ea8004dc3a40046e1d20005734aae7555cf2ab9f5740ae855d101";
        let script_cbor = apply_double_cbor_encoding(script).unwrap();
        let script_hash = get_script_hash(&script_cbor, LanguageVersion::V2).unwrap();
        assert_eq!(
            script_hash,
            "8fa9284f5889972d7260c10e940a2e1acb2114bdcea845da3d52de7d"
        );
    }

    #[test]
    fn test_get_script_hash_v3_escrow() {
        let script = "590d2301010032323232323232253330023232323232533233008300130093754004264646464646464646464a666024600e002264646464a666032603800426601200626601000244a6660360042a01026464660186eacc070008894ccc07c0084c014c0880184c8c8c8c010c094014dd698100011bae301e0013021002375c6034002603a0042c6eacc068004c068008c060004c050dd50068a99980918058008a99980a980a1baa00d1500216153330123003001153330153014375401a2a0042c2c60246ea80304c8c8c8c8c8c8c8c94ccc060c034c064dd500089919191919191919191919192999812180c80509919191919191929998171818801899299981798190018992999816980f18171baa00113232533302f302030303754002264a666060604a60626ea800c4c8c8c8c94ccc0dcc0e80084cc09c00c4cc098004894ccc0e40084cc05801c4c94ccc0dccdd780419ba548008cc0ec018cc0ecdd30021981d8091981d9ba60114bd7008008a50330173756603c60706ea802ccc064dd5980f181c1baa301e30383754018603402026464660546eacc0e8008894ccc0f40084c014c1000184c8c8c8c010c10c014dd6981f0011bae303c001303f002375c607000260760042c6eacc0e0004c0e0008c0d8004c0c8dd50018b181a18189baa001163010303037540066064605e6ea800458c038c0b8dd5180a18171baa00216303000216302f0023758605c605e0046eb0c0b4004cc0acdd39980200b007198159ba73300501400e4bd701bab302b302c002302a0013026375403e2646464a66604e604001a264646464a66605c60620062a66605c004264a666058603a605a6ea80044c8cc03400454ccc0b4c088c0b8dd50008992999817181198179baa00113300901a375c606660606ea800458c01cc0c8c0bcdd500089919191919191919299981a9815181b1baa001132325333037302c303837540022a66606e6466002002660786ea400ccc0f0c0f4c0e8dd500125eb80894ccc0f0004528099299981d1980a8131bae303f00214a2266006006002607e0022a66606e00a200829405280b18080029bae303a303737540022c601c00c660286601e040004602e6eacc0e0c0e400ccc04ccc03807c010c058dd5981b801981b000981b000981a801181980098179baa0013031302e37540022c601a605a6ea8c04cc0b4dd50008b0b18178011bac302e302f0023758605a002660566e9ccc010058038cc0acdd39980280a00725eb804c8c8c8c94ccc0b8c0c400c54ccc0b80084c94ccc0b0c074c0b4dd50008992999816981318171baa001132323232323232325333038303b00213302800713302700522533303a00213302a00513302900322533303c0021323232533303c3031303d375400226464a66607c6066607e6ea800454ccc0f8c8cc004004cc10cdd480199821982218209baa0024bd701129998218008a5113253330413301c02d375c608c0042660060060022940c11800454ccc0f801440105280a5016301700b375c6082607c6ea800458c054034cc06ccc05809c020c078028cc068cc05409802cc0740144c8c8cc0b4dd5981e8011129998200010980298218030991919180218230029bad3041002375c607e00260840046eb8c0ec004c0f80084c8c8cc0acdd5981d80111299981f0010980298208030991919180218220029bad303f002375c607a00260800046eb8c0e4004c0f000858dd5981c800981c801181b800981b8011bab303500130350023033001302f37540022c6062605c6ea800458c034c0b4dd5180998169baa0011616302f0023758605c605e0046eb0c0b4004cc0acdd39980200b007198159ba73300501400e4bd701192999814180e98149baa001130123302c302d302a375400297ae014c103d87a800030123029375400244646600200200644a66605800229404c94ccc0a8cdc79bae302f00200414a2266006006002605e00244646600200200644a666056002297adef6c6013322533302a3375e602a60586ea80080144cc034004dd5980918161baa0021001302d00133002002302e001223300400223375e602260506ea8c038c0a0dd50008011119801801119baf30103027375400200444646600200200644a666050002297ae0132325333027300500213302b00233004004001133004004001302c002302a001223253330233018001132323232533302a302d00213301a00313301900122533302c00215008132323301d3756605a00444a6660600042600a606600c26464646008606c00a6eb4c0c4008dd7181780098190011bae302b001302e002163756605600260560046052002604a6ea800c54ccc08cc0700044c8c8c8c8c8c8c8c94ccc0b8c0c40084cc07801c4cc074014894ccc0c00084cc0800144cc07c00c894ccc0c8008540384c8c8cc08cdd5981980111299981b00109802981c80309919191802181e0029bad3037002375c606a00260700046eb8c0c4004c0d00084c8c8cc084dd5981880111299981a00109802981b80309919191802181d0029bad3035002375c6066002606c0046eb8c0bc004c0c800858dd598178009817801181680098168011bab302b001302b0023029001302537540062c60466ea800888c8cc004004c8cc00400400c894ccc09c00452f5c0264666444646600200200644a66605a00220062646605e6e9ccc0bcdd4803198179816000998179816800a5eb80cc00c00cc0c4008c0bc004dd718130009bab302700133003003302b002302900122533302600114a2264a6660486466e24dd698038009991192999814181098149baa0011480004dd6981698151baa0013253330283021302937540022980103d87a8000132330010013756605c60566ea8008894ccc0b4004530103d87a8000132323232533302e337220100042a66605c66e3c0200084c060cc0c8dd4000a5eb80530103d87a8000133006006003375a605e0066eb8c0b4008c0c4008c0bc004c8cc004004024894ccc0b00045300103d87a8000132323232533302d337220100042a66605a66e3c0200084c05ccc0c4dd3000a5eb80530103d87a80001330060060033756605c0066eb8c0b0008c0c0008c0b8004dd718080009bae300d001375860520042660060060022940c0a40048c090c094c09400488c8ccc00400400c0088894ccc09400840044c8ccc010010c0a400ccccc020008dd718120009bab3025001222325333027533302a00114a229405300103d87a8000130113302b374c00297ae032333001001003002222533302c0021001132333004004303000333223233001001005225333031001133032337606ea4010dd4001a5eb7bdb1804c8c8c8c94ccc0c8cdc800400109981b19bb037520106ea001c01454ccc0c8cdc780400109929998199814181a1baa001133037337606ea4024c0e0c0d4dd5000802080219299981998140008a60103d87a80001301d33037375000297ae03370000e00226606c66ec0dd48011ba800133006006003375a60660066eb8c0c4008c0d4008c0cc004dd718158009bad302c001302e00230270022323300100100222533302200114bd6f7b6300999119191999804001801000911319190011919198008008019129998148008a4c264a6660540022a66604e60086eb4c0a4c0b000852616132323232533302b337206eb8c0b0010dd718160018a9998159804000899803803998178018010b0b1bad302c003302f003302d002302c002302c001233302430190014a0944dd598120019bae3022002302400133002002302500122223233001001005225333024001133025337606ea4014dd300225eb7bdb1804c8c8c8c94ccc094cdc800480109981499bb037520126e9802001454ccc094cdc78048010992999813180d98139baa00113302a337606ea4028c0acc0a0dd5000802080219980380480400089981499bb037520046e98004cc01801800cdd598130019bae302400230280023026001301b375402a600860366ea8c004c06cdd5180f180d9baa0022301e301f00116323300100100722533301c00114c0103d87a800013232533301b3375e600c603a6ea80080484c014cc07c0092f5c02660080080026040004603c0026e9520002301b001375860326034603460346034603460340046eb0c060004c060c060008dd6180b00098091baa00d370e900211191980080080191198018009801001112999807980218081baa00213232323253330163019002133007003132325333015300a00113232533301a301d002132325333019300e00113232533301e302100213300f0011500416301f001301b37540062a66603260240022646464646464a666044604a0042a0102c6eb4c08c004c08c008dd6981080098108011bad301f001301b37540062c60326ea80085401058c06c004c05cdd50018a99980a98070008a99980c180b9baa003150021616301537540042a00a2c602e002602e004602a00260226ea80085888c94ccc03cc0100044c8c94ccc050c05c0085401058dd7180a80098089baa0031533300f300800113232533301430170021500416375c602a00260226ea800c58c03cdd50011b8748000c03cc040008c038004c028dd50011b874800858c02cc030008c028004c028008c020004c010dd50008a4c26cacae6955ceaab9e5573eae815d0aba21";
        let script_cbor = apply_double_cbor_encoding(script).unwrap();
        let script_hash = get_script_hash(&script_cbor, LanguageVersion::V3).unwrap();
        assert_eq!(
            script_hash,
            "6e95d24ab0579b9e44c7cd1c801e1527c63124cef086d39443696b6b"
        );
    }
}
